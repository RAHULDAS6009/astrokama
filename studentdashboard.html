<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Student Corner - Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
  </head>

  <body class="bg-gray-100">
    <!-- Header -->
    <header
      class="bg-[#523A35] border-b-4 border-[#D4A017] px-4 py-5 text-center text-white shadow-md"
    >
      <h1
        class="text-3xl md:text-4xl font-extrabold text-[#f4d37d] tracking-wide drop-shadow mb-2"
      >
        MODERN ASTROLOGY
      </h1>
      <p class="text-xs md:text-sm font-semibold tracking-wide">
        KRISHNAMURTI ACADEMY OF MODERN ASTROLOGY & SPIRITUAL DEVELOPMENT
      </p>
    </header>

    <!-- Navbar -->
    <nav class="bg-[#523A35] shadow-lg sticky top-0 z-50">
      <div class="px-4 md:px-8 py-4 flex justify-between items-center">
        <h2 class="text-xl md:text-2xl font-bold text-white">
          Student Dashboard
        </h2>
        <button
          onclick="logout()"
          class="bg-white text-[#523A35] px-5 py-2 rounded-lg font-semibold hover:bg-gray-100 transition"
        >
          Logout
        </button>
      </div>
    </nav>

    <!-- Loading Spinner -->
    <div
      id="loadingSpinner"
      class="flex justify-center items-center min-h-screen"
    >
      <div
        class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-[#523A35]"
      ></div>
    </div>

    <!-- Error Message -->
    <div
      id="errorMessage"
      class="hidden p-4 m-8 bg-red-100 border border-red-400 text-red-700 rounded-lg"
    >
      <p class="font-bold">Error Loading Data</p>
      <p id="errorText"></p>
    </div>

    <!-- Main Content -->
    <div id="mainContent" class="hidden">
      <main class="p-4 md:p-8 space-y-8">
        <!-- Student Info -->
        <div class="bg-white rounded-xl shadow-lg p-6">
          <h3 class="text-xl font-bold text-[#523A35] mb-5">
            Student Information
          </h3>
          <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
            <div class="bg-gray-50 p-4 rounded-lg">
              <div class="text-xs text-gray-600 mb-1">Student Name</div>
              <div class="text-lg font-bold text-[#523A35]" id="studentName">
                -
              </div>
            </div>
            <div class="bg-gray-50 p-4 rounded-lg">
              <div class="text-xs text-gray-600 mb-1">Enrollment ID</div>
              <div class="text-lg font-bold text-[#523A35]" id="enrollmentId">
                -
              </div>
            </div>
            <div class="bg-gray-50 p-4 rounded-lg">
              <div class="text-xs text-gray-600 mb-1">Course</div>
              <div class="text-lg font-bold text-[#523A35]" id="courseName">
                -
              </div>
            </div>
            <div class="bg-gray-50 p-4 rounded-lg">
              <div class="text-xs text-gray-600 mb-1">Branch</div>
              <div class="text-lg font-bold text-[#523A35]" id="branchName">
                -
              </div>
            </div>
          </div>
        </div>

        <!-- Semesters -->
        <div id="semestersContainer" class="space-y-8"></div>
      </main>
    </div>

    <script>
      const API_BASE_URL = "http://localhost:5000/api/v1";
      let studentData = null;

      // Load student profile
      async function fetchStudentProfile() {
        try {
          const response = await fetch(`${API_BASE_URL}/student/profile`, {
            method: "GET",
            headers: {
              "Content-Type": "application/json",
              Authorization: "Bearer " + localStorage.getItem("token"),
            },
          });

          if (!response.ok) throw new Error("Failed to fetch profile");

          const result = await response.json();

          console.log(result);
          studentData = result.data;

          populateStudentInfo();
          renderSemesters();

          document.getElementById("loadingSpinner").classList.add("hidden");
          document.getElementById("mainContent").classList.remove("hidden");
        } catch (error) {
          showError(error.message);
        }
      }

      function showError(msg) {
        document.getElementById("loadingSpinner").classList.add("hidden");
        document.getElementById("errorMessage").classList.remove("hidden");
        document.getElementById("errorText").textContent = msg;
      }

      function populateStudentInfo() {
        document.getElementById("studentName").textContent =
          studentData.name || "-";
        document.getElementById("enrollmentId").textContent =
          studentData.studentId || "-";
        document.getElementById("courseName").textContent =
          studentData.course?.name || "-";
        document.getElementById("branchName").textContent =
          studentData.branch?.name || "-";
      }

      // Late Fine Calculation
      function calculateLateFine(dueDate, semester) {
        const today = new Date();
        const due = new Date(dueDate);

        if (today <= due) return 0;
        const lateFeeDate = semester.lateFeeDate
          ? new Date(semester.lateFeeDate)
          : due;

        return today > lateFeeDate ? semester.lateFeeFine || 0 : 0;
      }

      // Generate Payments
      function generateMonthlyPayments(semester, semesterFees) {
        const startDate = new Date(semester.startDate);
        const endDate = new Date(semester.endDate);
        const payments = [];

        // Admission Payment
        const admissionPayment = semesterFees.find(
          (f) => f.description === "Admission Fee"
        );

        payments.push({
          detail: "Admission",
          date: admissionPayment
            ? formatDate(admissionPayment.paymentDate)
            : "Pending",
          fees: semester.admissionFee || 0,
          lateFine: admissionPayment?.lateFine || 0,
          status: admissionPayment ? "Paid" : "Pending",
          mode: admissionPayment?.paymentMode || "-",
          isPending: !admissionPayment,
          dueDate: formatDate(semester.startDate),
        });

        // Monthly Fees
        const monthNames = [
          "Jan",
          "Feb",
          "Mar",
          "Apr",
          "May",
          "Jun",
          "Jul",
          "Aug",
          "Sep",
          "Oct",
          "Nov",
          "Dec",
        ];

        // Get all monthly fee payments sorted by payment date
        const monthlyPayments = semesterFees
          .filter((f) => f.description === "Monthly Fee" && f.paymentDate)
          .sort((a, b) => new Date(a.paymentDate) - new Date(b.paymentDate));

        let paymentIndex = 0;
        const current = new Date(startDate);

        while (current <= endDate) {
          const dueDate = new Date(
            current.getFullYear(),
            current.getMonth(),
            5
          );

          // Check if there's a payment available for this month slot
          const monthPayment =
            paymentIndex < monthlyPayments.length
              ? monthlyPayments[paymentIndex]
              : null;

          payments.push({
            detail: `Month ${monthNames[current.getMonth()]}-${current
              .getFullYear()
              .toString()
              .slice(-2)}`,
            date: monthPayment
              ? formatDate(monthPayment.paymentDate)
              : `Due: 5th ${
                  monthNames[current.getMonth()]
                } ${current.getFullYear()}`,
            fees: semester.fees || 0,
            lateFine: monthPayment
              ? monthPayment.lateFine
              : calculateLateFine(dueDate, semester),
            status: monthPayment ? "Paid" : "Pending",
            mode: monthPayment?.paymentMode || "-",
            isPending: !monthPayment,
            dueDate: formatDate(dueDate),
          });

          // If a payment was used for this month, move to next payment
          if (monthPayment) {
            paymentIndex++;
          }

          current.setMonth(current.getMonth() + 1);
        }

        return payments;
      }

      // Razorpay Payment
      async function handlePayment(semesterId, amount, detail, lateFine = 0) {
        const btn = event.target;
        btn.disabled = true;
        btn.textContent = "Processing...";

        try {
          // Fetch Razorpay Key
          const keyRes = await fetch(`${API_BASE_URL}/student/razorpay-key`, {
            headers: {
              Authorization: "Bearer " + localStorage.getItem("token"),
            },
          });
          const keyData = await keyRes.json();

          // Create Order
          const orderRes = await fetch(
            `${API_BASE_URL}/student/pay/create-order`,
            {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                Authorization: "Bearer " + localStorage.getItem("token"),
              },
              body: JSON.stringify({
                semesterId,
                amount,
                description: detail.includes("Admission")
                  ? "Admission Fee"
                  : "Monthly Fee",
              }),
            }
          );

          const orderData = await orderRes.json();
          const order = orderData.data;

          // Razorpay Options
          const options = {
            key: keyData.key,
            amount: order.amount,
            currency: order.currency,
            order_id: order.id,
            name: "Modern Astrology",
            description: detail,

            handler: async function (response) {
              await fetch(`${API_BASE_URL}/student/pay/verify`, {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                  Authorization: "Bearer " + localStorage.getItem("token"),
                },
                body: JSON.stringify({
                  razorpay_payment_id: response.razorpay_payment_id,
                  razorpay_order_id: response.razorpay_order_id,
                  razorpay_signature: response.razorpay_signature,
                  semesterId,
                  amount,
                  lateFine,
                  description: detail.includes("Admission")
                    ? "Admission Fee"
                    : "Monthly Fee",
                }),
              });

              alert("Payment Successful!");
              window.location.reload();
            },

            prefill: {
              name: studentData.name,
              email: studentData.email,
              contact: studentData.mobileNumber,
            },

            theme: { color: "#523A35" },

            modal: {
              ondismiss: function () {
                btn.disabled = false;
                btn.textContent = "Pay Now";
              },
            },
          };

          const rzp = new Razorpay(options);

          rzp.on("payment.failed", function (response) {
            alert("Payment Failed: " + response.error.description);
            btn.disabled = false;
            btn.textContent = "Pay Now";
          });

          rzp.open();
        } catch (error) {
          alert("Payment Error");
          btn.disabled = false;
          btn.textContent = "Pay Now";
        }
      }

      // Render Semesters
      function renderSemesters() {
        const container = document.getElementById("semestersContainer");
        const semesters = studentData.branch?.semsters || [];
        const fees = studentData.fees || [];

        container.innerHTML = semesters
          .map((sem) => {
            const semFees = fees.filter((f) => f.semesterId === sem.id);
            const payments = generateMonthlyPayments(sem, semFees);

            const total = payments.reduce(
              (sum, p) => sum + p.fees + p.lateFine,
              0
            );

            return `
            <div class="bg-white rounded-xl shadow-lg overflow-hidden">
              <div class="bg-[#523A35] text-white px-6 py-4 text-xl font-bold">
                Semester ${sem.number}: ${sem.name}
              </div>

              <div class="p-6 overflow-x-auto">
                <table class="w-full border-collapse">
                  <thead>
                    <tr class="bg-[#523A35] text-white text-sm">
                      <th class="border px-4 py-3">Details</th>
                      <th class="border px-4 py-3">Date</th>
                      <th class="border px-4 py-3">Fees</th>
                      <th class="border px-4 py-3">Late Fine</th>
                      <th class="border px-4 py-3">Total</th>
                      <th class="border px-4 py-3">Status</th>
                      <th class="border px-4 py-3">Action</th>
                    </tr>
                  </thead>

                  <tbody class="text-sm">
                    ${payments
                      .map(
                        (p) => `
                      <tr class="hover:bg-gray-50">
                        <td class="border px-4 py-3">${p.detail}</td>
                        <td class="border px-4 py-3">${p.date}</td>
                        <td class="border px-4 py-3">₹${p.fees}</td>
                        <td class="border px-4 py-3 ${
                          p.lateFine > 0 ? "text-red-600 font-bold" : ""
                        }">
                          ₹${p.lateFine}
                        </td>
                        <td class="border px-4 py-3 font-bold">₹${
                          p.fees + p.lateFine
                        }</td>

                        <td class="border px-4 py-3">
                          <span class="${
                            p.status === "Paid" ? "bg-green-600" : "bg-red-600"
                          } text-white px-3 py-1 rounded-full text-xs">
                            ${p.status}
                          </span>
                        </td>

                        <td class="border px-4 py-3">
                          ${
                            p.isPending
                              ? `<button onclick="handlePayment('${sem.id}', ${
                                  p.fees + p.lateFine
                                }, '${p.detail}', ${p.lateFine})"
                                          class="bg-[#523A35] hover:bg-[#3d2a27] text-white px-4 py-2 rounded-lg text-xs font-semibold">
                                    Pay Now
                                  </button>`
                              : `<span class="text-green-600 text-xs font-bold">✓ Paid</span>`
                          }
                        </td>
                      </tr>
                    `
                      )
                      .join("")}

                    <tr class="bg-gray-200 font-bold">
                      <td colspan="4" class="border px-4 py-3 text-right">Total</td>
                      <td colspan="3" class="border px-4 py-3 text-lg">₹${total}</td>
                    </tr>

                  </tbody>
                </table>
              </div>
            </div>
          `;
          })
          .join("");
      }

      function formatDate(d) {
        if (!d) return "-";
        const date = new Date(d);
        const m = [
          "Jan",
          "Feb",
          "Mar",
          "Apr",
          "May",
          "Jun",
          "Jul",
          "Aug",
          "Sep",
          "Oct",
          "Nov",
          "Dec",
        ];
        return `${date.getDate()} ${m[date.getMonth()]} ${date.getFullYear()}`;
      }

      function logout() {
        localStorage.removeItem("token");
        window.location.href = "studentcorner.html";
      }

      document.addEventListener("DOMContentLoaded", fetchStudentProfile);
    </script>
  </body>
</html>
